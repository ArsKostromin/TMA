# –§–∞–π–ª: pyrogram/core/auth/auth_handler.py

import logging
from pyrogram import Client, idle
from pyrogram.errors import SessionPasswordNeeded, FloodWait

# –õ–æ–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
logger = logging.getLogger("pyrogram-main")

async def run_client(app: Client):
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç, –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Pyrogram Client.
    """
    logger.info("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...")
    
    # **–ü–†–ò –ü–ï–†–í–û–ú –ó–ê–ü–£–°–ö–ï:**
    # –ò–º–µ–Ω–Ω–æ –∑–¥–µ—Å—å, –≤–Ω—É—Ç—Ä–∏ `await app.start()`, Pyrogram –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
    # –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏/2FA –ø–∞—Ä–æ–ª—å –≤ –∫–æ–Ω—Å–æ–ª–∏.

    try:
        await app.start()
        
        me = await app.get_me()
        logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –∫–∞–∫: {me.first_name} (@{me.username})")
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        # await app.send_message("me", f"‚úÖ –Æ–∑–µ—Ä–±–æ—Ç –Ω–∞ Pyrogram —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!\n–í—Ö–æ–¥ –æ—Ç: {me.first_name}")
        
        logger.info("–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç. (–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...)")
        
        # –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –¥–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç—É –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
        await idle() 
        
    except SessionPasswordNeeded:
        logger.error("–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA).")
        logger.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –µ—â–µ —Ä–∞–∑ –∏ –≤–≤–µ–¥–∏—Ç–µ 2FA –ø–∞—Ä–æ–ª—å, –∫–æ–≥–¥–∞ –µ–≥–æ –ø–æ–ø—Ä–æ—Å—è—Ç.")
        
    except FloodWait as e:
        logger.error(f"‚ùå –û–®–ò–ë–ö–ê TELEGRAM (FloodWait): –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞.")
        logger.error(f"–¢–µ–±–µ –Ω—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å {e.value} —Å–µ–∫—É–Ω–¥ ({round(e.value / 3600, 1)} —á–∞—Å–æ–≤), –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.")
        
    except Exception as e:
        logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞: {e}")
        
    finally:
        if app.is_connected:
            await app.stop()
            logger.info("üëã –ö–ª–∏–µ–Ω—Ç Pyrogram –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")